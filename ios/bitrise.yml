format_version: '13'
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git
project_type: react-native
workflows:
  primary:
    steps:
    - git-clone@8: {}
    - script@1:
        title: Install Dependencies
        inputs:
          - content: |-
              #!/bin/bash
              set -ex

              # Install Node.js dependencies
              npm install

              # Install iOS dependencies using CocoaPods
              cd ios
              pod install --repo-update
              cd ..
    - script@1:
        title: Set Environment Variables
        inputs:
          - content: |-
              #!/bin/bash
              set -ex

              # Define the workspace path and scheme for iOS
              WORKSPACE_PATH="$BITRISE_SOURCE_DIR/ios/MyApp.xcworkspace"
              SCHEME="MyApp"

              # Verify the workspace file exists
              if [ ! -f "$WORKSPACE_PATH" ]; then
                echo "Error: Workspace file not found at $WORKSPACE_PATH"
                exit 1
              fi

              # Set environment variables for Bitrise steps
              envman add --key BITRISE_WORKSPACE_PATH --value "$WORKSPACE_PATH"
              envman add --key BITRISE_SCHEME --value "$SCHEME"

              echo "iOS Workspace Path: $WORKSPACE_PATH"
              echo "iOS Scheme: $SCHEME"
    - script@1:
        title: Update Build Number (iOS)
        inputs:
          - content: |-
              #!/bin/bash
              set -ex

              # Find the .xcodeproj file dynamically
              XCODEPROJ_PATH=$(find "$BITRISE_SOURCE_DIR/ios" -name "*.xcodeproj" | head -n 1)

              if [ -z "$XCODEPROJ_PATH" ]; then
                echo "Error: Xcode project file not found."
                exit 1
              fi

              echo "Xcode project path: $XCODEPROJ_PATH"

              # Update build number using agvtool
              cd "$(dirname "$XCODEPROJ_PATH")"
              agvtool new-version -all "$BITRISE_BUILD_NUMBER"
    - xcode-archive@5:
        inputs:
          - project_path: "$BITRISE_WORKSPACE_PATH"
          - scheme: "$BITRISE_SCHEME"
          - distribution_method: app-store
          - automatic_code_signing: api-key
          - configuration: Release
    - android-build@0.10.0:
        inputs:
          - variant: release
    - deploy-to-bitrise-io@2: {}
    triggers:
      push:
      - branch: main
      pull_request:
      - source_branch: "*"
meta:
  bitrise.io:
    stack: osx-xcode-16.0.x
    machine_type_id: g2-m1.4core
app:
  envs:
  - BITRISE_KEYCHAIN_PASSWORD: anything
  - BITRISE_TEAM_ID: 22X77ENQ2H
  - CERTIFICATE_PASSWORD: 123456
